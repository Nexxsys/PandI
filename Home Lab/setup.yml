---
- name: Setup new Linux VM
  hosts: localhost
  become: true
  become_method: sudo

  tasks:
    - name: Update apt cache and upgrade packages
      apt: 
        update_cache: yes
        upgrade: 'yes'
    # Takes a long time to run
    #- name: setup ansible galaxy
    #  shell: ansible-galaxy collection install community.general

    - name: Add Sublime Text GPG key
      shell: wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/sublimehq-archive.gpg > /dev/null

    - name: Add Sublime Text repository
      shell: echo "deb https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime-text.list

    - name: pipx ensurepath
      shell: pipx ensurepath

    - name: Install necessary packages
      apt:
        name: 
          - pipx
          - gdb
          - git 
          - sublime-text 
          - synaptic 
          - apt-transport-https 
          - xclip 
          - terminator 
          - cifs-utils 
          - byobu 
          - lsd
          #- chromium-browser # will likely error
          - exiftool
          - jq
          # - python3-neo4j 
        state: latest
      ignore_errors: 'yes'

    - name: Install package with pipx
      community.general.pipx:
        name: netexec
        source: git+https://github.com/Pennyw0rth/NetExec
        name: crackmapexec
        source: git+https://github.com/Porchetta-Industries/CrackMapExec.git
      ignore_errors: 'yes'

    - name: "Installing useful github repos"
      git:
        repo: "{{ item.repo }}"
        dest: "{{ item.location }}"
      loop:
        - { repo: "https://github.com/Flangvik/SharpCollection", location: "/opt/SharpCollection" }
        - { repo: "https://github.com/danielmiessler/SecLists", location: "/opt/SecLists" }
      become: true
      become_method: sudo

    - name: Create temporary build directory
      ansible.builtin.tempfile:
        state: directory
      register: build_dir

    - name: "Copying python script to download github releases"
      copy:
        src: "files/githubdownload.py"
        dest: "{{ build_dir.path }}/githubdownload.py"
        owner: root
        group: root
        mode: 0755
      become: true
      become_method: sudo

    - name: "Downloading github releases"
      shell: "{{ build_dir.path }}/githubdownload.py {{ item.repo }} {{ item.regex }} {{ item.location }} {% if item.filename is defined %}{{ item.filename }}{% endif %}"
      loop:
        - { repo: "jpillora/chisel",  regex: "_linux_amd64.gz", location: "/opt/chisel" }
        - { repo: "jpillora/chisel",  regex: "_windows_amd64.gz", location: "/opt/chisel" }
        #- { repo: "jpillora/chisel",  regex: "_darwin_amd64", location: "/opt/chisel", filename: "chisel_osx" }
        - { repo: "carlospolop/PEASS-ng",  regex: "linpeas.sh", location: "/opt/peas" }
        - { repo: "carlospolop/PEASS-ng",  regex: "winPEASx64.exe", location: "/opt/peas" }
        - { repo: "WithSecureLabs/chainsaw",  regex: "chainsaw_all_", location: "/opt/" }
        - { repo: "BloodHoundAD/BloodHound", regex: "BloodHound-linux-x64.zip", location: "/opt/" }
      async: 45
      poll: 0
      become: true
      become_method: sudo

    - name: Remove temporary build directory
      ansible.builtin.file:
        path: "{{ build_dir.path }}"
        state: absent
      when: build_dir.path is defined

    - name: "Installing tools from Gems"
      gem:
        name: "{{ item }}"
        state: latest
      loop:
        - logger
        - stringio
        - winrm
        - builder
        - erubi
        - gssapi
        - gyoku
        - httpclient
        - logging
        - little-plugger
        - nori
        - rubyntlm
        - winrm-fs
        - evil-winrm
      become: true
      become_method: sudo
  
    - name: "Install pipx tools"
      community.general.pipx:
        name: "{{ item.name }}"
        source: "{{ item.url }}"
        state: latest
      loop:
        - { name: 'impacket', url: 'git+https://github.com/fortra/impacket.git' }
        # - { name: 'crackmapexec', url: 'git+https://github.com/Porchetta-Industries/CrackMapExec.git' }
        - { name: 'certipy-ad', url: 'git+https://github.com/ly4k/Certipy.git' }

'
